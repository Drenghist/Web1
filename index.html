<!doctype html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Control de cambio de baterías</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/cover/">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link href="cosas.css" rel="stylesheet">
    <script src="jquery.js"></script>
    <script src="contador.js"></script>
    <script>
      let lanzado = false;
      function iniciar() {
        //Llamo a la función para que active el NFC -------------------------------------------------
         
        activaNFC();
        $("#contador").hide();
        $("#contador").removeClass("invisible"); //Lo hago visible después de haberlo "hideado".
      }

      function leer (texto) {
        if (texto.substring(0,2) == "*B") {
          if ($("#input1").val() == "") {
            $("#input1").val(texto.substring(2,(texto.length-1)));
            $("#input1").removeClass("is-invalidalex");
            $("#input1").addClass("is-validalex");
          } else if ($("#input1").val() == texto.substring(2,(texto.length-1))) {
            alert("Batería ya leída!");
          } else {
            $("#input2").val(texto.substring(2,(texto.length-1)));
            $("#input2").removeClass("is-invalidalex");
            $("#input2").addClass("is-validalex");
            prelanzar();
          }
        } else if (texto.substring(0,2) == "*U") {
          $("#input4").val(texto.substring(2,(texto.length-1)));
          $("#input4").addClass("is-validalex");
          prelanzar();
        } else if (texto.substring(0,2) == "*C") {
          $("#input3").val(texto.substring(2,(texto.length-1)));
          $("#input3").removeClass("is-invalidalex");
          $("#input3").addClass("is-validalex");
          prelanzar();
        } else if (texto.substring(0,2) == "*X") {
          $("#input5").val(texto.substring(2,(texto.length-1)));
          $("#input5").addClass("is-validalex");
          prelanzar();
        } else {
          alert("Código no reconocido");
        }

      }

      function prelanzar() {
        if (($("#input1").val() != "")&&($("#input2").val() != "")&&($("#input3").val() != "") && (lanzado == false)) {
          lanzar("contador",5000);
          lanzado = true;
        }
      }

      //Función asíncrona que active el NFC -------------------------------------------------
      async function activaNFC() {
        const nfcPermissionStatus = await navigator.permissions.query({ name: "nfc" });
        if (nfcPermissionStatus.state === "granted") {
          document.getElementById("boton1").style.display = 'none';
          $("#formulario").removeClass("visually-hidden");
          try{
              const ndef = new NDEFReader();
              console.log("antes del wait");
              await ndef.scan();
              console.log("after wait");
              ndef.addEventListener("readingerror", () => {
                alert("Argh! Cannot read data from the NFC tag. Try another one?");
              });

              ndef.addEventListener("reading", ({ message, serialNumber }) => {
                console.log(`> Serial Number: ${serialNumber}`);
                console.log(`> Records: (${message.records.length})`);
                for (const record of message.records){
                  const textDecoder = new TextDecoder(record.encoding);
                  console.log(`Contenido: ${textDecoder.decode(record.data)}`);
                  //document.getElementById("input1").value = textDecoder.decode(record.data);
                  leer(textDecoder.decode(record.data));
                }
              });
            } catch (error) {
              alert("Argh! " + error);
            }
          }else {
          document.getElementById("boton1").style.display = 'inline'; 
          $("#formulario").addClass("visually-hidden");
          document.getElementById("boton1").addEventListener("click", async () => {
            
            try {
              const ndef2 = new NDEFReader();
              await ndef2.scan();
              document.getElementById("boton1").style.display = 'none';
              $("#formulario").removeClass("visually-hidden");
              //Meto aquí el código que se ejecutó arriba si estaba activo el permiso
              try{
              const ndef = new NDEFReader();
              console.log("antes del wait");
              await ndef.scan();
              console.log("after wait");
              ndef.addEventListener("readingerror", () => {
                alert("Argh! Cannot read data from the NFC tag. Try another one?");
              });

              ndef.addEventListener("reading", ({ message, serialNumber }) => {
                console.log(`> Serial Number: ${serialNumber}`);
                console.log(`> Records: (${message.records.length})`);
                for (const record of message.records){
                  const textDecoder = new TextDecoder(record.encoding);
                  console.log(`Contenido: ${textDecoder.decode(record.data)}`);
                  //document.getElementById("input1").value = textDecoder.decode(record.data);
                  leer(textDecoder.decode(record.data));
                }
              });
            } catch (error) {
              alert("Argh! " + error);
            }
              
            } catch (error) {
              alert("OJO! " + error);
            }

          },true);
          
        }
      } 


      function focus1 () {
        if (document.getElementById("input1").value != ""){
          document.getElementById("input2").focus();
        } else {
          document.getElementById("input1").focus();
        }
      }

      window.addEventListener("load",iniciar,false);
       
       
      

     
    </script>
    

    <!-- Bootstrap core CSS -->


    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    
    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet">
  </head>
  <body class="d-flex h-100 text-center text-white bg-dark">
    
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
        <div>
          <h3 class="float-md-start mb-0">CCB</h3>
          <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link active" aria-current="page" href="#">Inicio</a>
            <a class="nav-link" href="drenghist.sytes.net/server2.php">Registros</a>
            <a class="nav-link" href="#">Contacto</a>
          </nav>
        </div>
      </header>
      <main class="px-3">
        <h1>Registro de cambio de baterías</h1><br/><h1>Test NFC</h1>
        
        <hr/>
        <input type="button" class ="btn btn-warning" id="boton1" value="Activar NFC" style="display:none; width: 80%"></input>
        <form id="formulario">
          <div class="row text-end">  
            <label for="input1" class="col-5" style="pointer-events:none">Batería vacía</label>
            <input id="input1" name="origen" style="width:40%; pointer-events:none" class="is-invalidalex col-5"></input>
          </div><br/>
          <div class="row text-end">
            <label for="input2" class="col-5" style="pointer-events:none">Batería cargada</label>
            <input id="input2" name="destino" style="width:40%; pointer-events:none" class="is-invalidalex col-5"></input>
          </div><br/>
          <div class="row text-end">
            <label for="input3" class="col-5" style="pointer-events:none">Carretilla</label>
            <input id="input3" name="carretilla" style="width:40%; pointer-events:none" class="is-invalidalex col-5"></input>
          </div><br/>
          <div class="row text-end">
            <label for="input4" class="col-5" style="pointer-events:none">Operario</label>
            <input id="input4" name="usuario" style="width:40%; pointer-events:none" class="col-5"></input>
          </div><br/>
          <div class="row text-end">
            <label for="input5" class="col-5" style="pointer-events:none">Observaciones</label>
            <input id="input5" name="obs" style="width:40%; pointer-events:none" class="col-5"></input>
          </div><br/>
        </form>
        
        <p class="lead">

        </p>
      </main>
      <!--
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Holy guacamole!</strong> You should check in on some of those fields below.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    -->

      <footer class="mt-auto text-white-50">
        <div style="width:70%; height:5em" class="mx-auto">
          <div id="contador" class="alert alert-warning invisible" >
          </div>
        </div>
      </footer>
    </div>


    
  </body>
</html>
